#!/usr/bin/env bash

# Install node packages
npm install

# Install Buildkite Test Engine Client
# See https://buildkite.com/docs/test-engine/test-splitting/client-installation
if [ -z "${BKTEC_VERSION}" ]; then
  echo "Error: BKTEC_VERSION environment variable is not set"
  echo "Set it with: export BKTEC_VERSION=2.1.0-rc.3"
  exit 1
fi
curl -L "https://github.com/buildkite/test-engine-client/releases/download/v${BKTEC_VERSION}/bktec_${BKTEC_VERSION}_linux_amd64" -o ./bktec 
chmod +x ./bktec

# Configure Buildkite Test Engine Client
# See https://buildkite.com/docs/test-engine/test-splitting/configuring
export BUILDKITE_TEST_ENGINE_TEST_RUNNER=jest
export BUILDKITE_TEST_ENGINE_RESULT_PATH=jest-result.json

# Configure retry settings for flaky test handling
export BUILDKITE_TEST_ENGINE_RETRY_COUNT=3
export BUILDKITE_TEST_ENGINE_RETRY_CMD="npx jest {{testExamples}} --testNamePattern '{{testNamePattern}}' --json --testLocationInResults --outputFile {{resultPath}}"

# Run Buildkite Test Engine Client
./bktec run
